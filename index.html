<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jessie Math - å››å¹´ç´šçµ±è¨ˆåœ–è¡¨å†’éšª</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-yellow: #FFB800;
            --secondary-blue: #5D5FEF;
            --bg-light: #F8F9FF;
            --text-dark: #2D3436;
            --accent-red: #FF4757;
            --accent-green: #2ED573;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Noto Sans TC', sans-serif; }
        body { background-color: var(--bg-light); color: var(--text-dark); overflow-x: hidden; }

        /* --- Header / Hero Section --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 5%;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .hero-left { display: flex; align-items: center; gap: 15px; }
        .logo-circle {
            width: 50px;
            height: 50px;
            background: var(--primary-yellow);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .logo-circle img { width: 100%; height: 100%; object-fit: cover; }
        .brand-name { font-size: 24px; font-weight: 700; color: #2C3E50; }

        .nav-right { display: flex; gap: 10px; }
        .nav-btn {
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: 0.3s;
            border: 1px solid #E0E0E0;
            color: #555;
            background: white;
            cursor: pointer;
        }
        .nav-btn.active { background: #EEF2FF; color: var(--secondary-blue); border-color: var(--secondary-blue); }
        .nav-btn:hover { background: #f0f0f0; }

        /* --- Game Containers --- */
        .container { max-width: 800px; margin: 40px auto; padding: 20px; text-align: center; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); position: relative; overflow: hidden; }
        .hidden { display: none !important; }

        input[type="text"] {
            padding: 12px 20px;
            width: 80%;
            border-radius: 10px;
            border: 2px solid #DDD;
            margin: 20px 0;
            font-size: 18px;
        }
        .btn-main {
            background: var(--secondary-blue);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 30px;
            font-size: 18px;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 4px 15px rgba(93, 95, 239, 0.3);
        }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(93, 95, 239, 0.4); }

        /* --- Stage Selection --- */
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 20px; }
        .stage-card {
            background: #fff;
            border: 2px solid #EEE;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: 0.3s;
        }
        .stage-card:hover { border-color: var(--primary-yellow); transform: scale(1.05); }
        .stage-card i { font-size: 40px; color: var(--primary-yellow); margin-bottom: 10px; }

        /* --- Game Area --- */
        .game-stats { display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 18px; font-weight: bold; }
        .timer { color: var(--accent-red); }
        .score { color: var(--secondary-blue); }
        .combo-text { color: orange; font-style: italic; font-size: 24px; height: 30px; }

        .visual-card { 
            background: #f0f4f8; 
            border-radius: 15px; 
            padding: 30px 20px 40px 20px; 
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 220px;
            gap: 20px;
            border: 1px dashed #ccc;
            position: relative;
        }
        .bar { width: 45px; background: var(--secondary-blue); position: relative; border-radius: 5px 5px 0 0; transition: height 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .bar-label { position: absolute; bottom: -35px; left: 50%; transform: translateX(-50%); font-size: 14px; font-weight: bold; white-space: nowrap; }
        
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .option-btn {
            background: white;
            border: 2px solid #DDD;
            padding: 15px;
            border-radius: 12px;
            font-size: 18px;
            cursor: pointer;
            transition: 0.2s;
        }
        .option-btn:hover { border-color: var(--secondary-blue); background: #f8f9ff; }
        .option-btn:active { transform: scale(0.95); }

        /* --- Feedback Overlays --- */
        .feedback-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; color: white; border-radius: 20px; animation: fadeIn 0.3s;
        }
        .correct-bg { background: rgba(46, 213, 115, 0.9); }
        .wrong-bg { background: rgba(255, 71, 87, 0.9); }
        .feedback-icon { font-size: 80px; margin-bottom: 10px; animation: pop 0.4s; }

        #pause-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.8); z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;
        }

        /* --- RWD --- */
        @media (max-width: 600px) {
            header { padding: 10px; }
            .nav-right { flex-wrap: wrap; justify-content: center; gap: 5px; }
            .grid-3 { grid-template-columns: 1fr; }
            .options-grid { grid-template-columns: 1fr; }
            .bar { width: 35px; gap: 10px; }
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pop { 0% { transform: scale(0.5); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <header>
        <div class="hero-left">
            <div class="logo-circle">
                <img src="JESSIEMATH-Q.png" alt="Logo">
            </div>
            <span class="brand-name">Jessie Math</span>
        </div>
        <div class="nav-right">
            <a href="https://jessiemath0703-chu.github.io/website2/" class="nav-btn"><i class="fas fa-home"></i> é¦–é </a>
            <a href="https://jessiemath0703-chu.github.io/Game-Lobby/" class="nav-btn"><i class="fas fa-gamepad"></i> éŠæˆ²å¤§å»³</a>
            <a href="https://jessiemath0703-chu.github.io/Game-Lobby/#g4-u10" class="nav-btn active"><i class="fas fa-chevron-left"></i> å››å¹´ç´šçµ±è¨ˆåœ–è¡¨</a>
        </div>
    </header>

    <div class="container">
        <div id="setup-screen" class="card">
            <h2>ğŸ“Š çµ±è¨ˆåœ–è¡¨å†’éšªç‹</h2>
            <input type="text" id="player-name" placeholder="è«‹è¼¸å…¥ä½ çš„è‹±é›„åå­—..." maxlength="10">
            <div style="text-align: left; background: #f0f2f5; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <p><strong>ğŸ“œ å†’éšªæ‰‹å†Šï¼š</strong></p>
                <ul style="margin-left: 20px; line-height: 1.8;">
                    <li>âŒ› å€’æ•¸è¨ˆæ™‚ <b>60 ç§’</b>ï¼Œçœ‹èª°åˆ†æ•¸é«˜ã€‚</li>
                    <li>â­• ç­”å°ï¼š+50 åˆ†ï¼Œ<b>æ™‚é–“çå‹µ 5 ç§’</b>ã€‚</li>
                    <li>âŒ ç­”éŒ¯ï¼šä¸åŠ åˆ†ï¼Œ<b>æ™‚é–“æ‰£é™¤ 5 ç§’</b>ã€‚</li>
                    <li>ğŸ”¥ é€£æ“Š (Combo)ï¼šé€£çºŒç­”å°åˆ†æ•¸æœ‰åŠ ä¹˜çé‡‘ï¼</li>
                </ul>
            </div>
            <button class="btn-main" onclick="toStageSelect()">é¸æ“‡é—œå¡</button>
        </div>

        <div id="stage-screen" class="card hidden">
            <h3>è«‹é¸æ“‡å†’éšªä¸»é¡Œ</h3>
            <div class="grid-3">
                <div class="stage-card" onclick="startGame(1)">
                    <i class="fas fa-chart-bar"></i>
                    <h4>ç¬¬ä¸€é—œ</h4>
                    <p>å ±è®€é•·æ¢åœ–</p>
                </div>
                <div class="stage-card" onclick="startGame(2)">
                    <i class="fas fa-calculator"></i>
                    <h4>ç¬¬äºŒé—œ</h4>
                    <p>æ•¸æ“šå¤§æŒ‘æˆ°</p>
                </div>
                <div class="stage-card" onclick="startGame(3)">
                    <i class="fas fa-chart-line"></i>
                    <h4>ç¬¬ä¸‰é—œ</h4>
                    <p>å ±è®€æŠ˜ç·šåœ–</p>
                </div>
            </div>
        </div>

        <div id="game-screen" class="card hidden">
            <div id="feedback" class="feedback-overlay hidden">
                <i id="feedback-icon" class="fas"></i>
                <h2 id="feedback-text"></h2>
                <p id="feedback-answer" style="font-size: 22px; margin-top: 15px; font-weight: bold;"></p>
            </div>

            <div class="game-stats">
                <div class="timer"><i class="fas fa-hourglass-half"></i> <span id="time-left">60</span>s</div>
                <div id="combo-display" class="combo-text"></div>
                <div class="score">å¾—åˆ†: <span id="current-score">0</span></div>
            </div>
            
            <div class="question-area">
                <p id="scenario-text" style="color: #666; font-size: 14px; margin-bottom: 5px;"></p>
                <h3 id="question-text" style="margin-bottom: 15px; color: #2D3436; min-height: 50px;">è¼‰å…¥ä¸­...</h3>
                <div id="visual-container" class="visual-card"></div>
                <div id="options" class="options-grid"></div>
            </div>

            <div class="game-ctrls" style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
                <button class="nav-btn" onclick="resetGame()"><i class="fas fa-redo"></i> é‡æ–°</button>
                <button class="nav-btn" onclick="togglePause()"><i class="fas fa-pause"></i> æš«åœ</button>
                <button class="nav-btn" onclick="backToMenu()"><i class="fas fa-times"></i> æ”¾æ£„</button>
            </div>
        </div>

        <div id="result-screen" class="card hidden">
            <h2 id="result-title">å†’éšªçµæŸï¼</h2>
            <div id="star-rating" style="font-size: 50px; color: gold; margin: 15px 0;"></div>
            <p style="font-size: 28px; font-weight: bold; color: var(--secondary-blue);">æœ€çµ‚å¾—åˆ†ï¼š<span id="final-score">0</span></p>
            <div id="leaderboard" style="margin: 25px 0; text-align: left; background: #f8f9fa; padding: 20px; border-radius: 15px; border: 1px solid #eee;">
                <strong>ğŸ† è‹±é›„æ’è¡Œæ¦œ</strong>
                <ul id="leader-list" style="list-style: none; margin-top: 10px;"></ul>
            </div>
            <button class="btn-main" onclick="backToMenu()">å†æ¬¡æŒ‘æˆ°</button>
        </div>
    </div>

    <div id="pause-overlay" class="hidden">
        <i class="fas fa-pause-circle" style="font-size: 80px; margin-bottom: 20px;"></i>
        <h1>éŠæˆ²ä¼‘æ¯ä¸­...</h1>
        <button class="btn-main" style="margin-top: 30px;" onclick="togglePause()">ç¹¼çºŒå†’éšª</button>
    </div>

    <script>
        let playerName = "";
        let currentStage = 1;
        let score = 0;
        let timeLeft = 60;
        let timerInterval;
        let combo = 0;
        let isPaused = false;
        let isAcceptingInput = true;
        let currentAnswer = "";

        const SCENARIOS = [
            { title: "ğŸ æ°´æœåº—éŠ·é‡çµ±è¨ˆ", items: ["è˜‹æœ", "é¦™è•‰", "è¥¿ç“œ", "è‘¡è„"] },
            { title: "ğŸ‘• æœé£¾åº—å„è‰²è¡£é‡", items: ["ç´…è¡£", "è—è¡£", "é»ƒè¡£", "ç¶ è¡£"] },
            { title: "ğŸƒ ç­ç´šé‹å‹•æœƒäººæ•¸", items: ["å¤§ç­", "äºŒç­", "ä¸‰ç­", "å››ç­"] },
            { title: "ğŸ“š åœ–æ›¸é¤¨å€Ÿæ›¸æ•¸é‡", items: ["é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››"] },
            { title: "ğŸ¦ å†°æ·‡æ·‹å£å‘³çµ±è¨ˆ", items: ["è‰è“", "é¦™è‰", "å·§å…‹åŠ›", "è–„è·"] }
        ];

        // --- æ ¸å¿ƒæµç¨‹ ---
        function toStageSelect() {
            playerName = document.getElementById('player-name').value.trim();
            if(!playerName) { alert("è«‹å…ˆè¼¸å…¥åå­—å–”ï¼"); return; }
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('stage-screen').classList.remove('hidden');
        }

        function startGame(stage) {
            currentStage = stage;
            score = 0;
            timeLeft = 60;
            combo = 0;
            isPaused = false;
            isAcceptingInput = true;
            document.getElementById('stage-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            updateStats();
            nextQuestion();
            startTimer();
        }

        function backToMenu() {
            clearInterval(timerInterval);
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('stage-screen').classList.remove('hidden');
        }

        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if(!isPaused) {
                    timeLeft--;
                    document.getElementById('time-left').innerText = timeLeft;
                    if(timeLeft <= 0) endGame();
                }
            }, 1000);
        }

        function togglePause() {
            isPaused = !isPaused;
            document.getElementById('pause-overlay').classList.toggle('hidden');
        }

        function resetGame() {
            clearInterval(timerInterval);
            startGame(currentStage);
        }

        function updateStats() {
            document.getElementById('current-score').innerText = score;
            document.getElementById('time-left').innerText = timeLeft;
            const comboDiv = document.getElementById('combo-display');
            comboDiv.innerText = combo >= 2 ? `ğŸ”¥ Combo x${combo}` : "";
        }

        // --- å‡ºé¡Œé‚è¼¯ ---
        function nextQuestion() {
            const visual = document.getElementById('visual-container');
            const optionsDiv = document.getElementById('options');
            const scene = SCENARIOS[Math.floor(Math.random() * SCENARIOS.length)];
            
            visual.innerHTML = "";
            optionsDiv.innerHTML = "";
            document.getElementById('scenario-text').innerText = scene.title;

            let data = [];
            for(let i=0; i<4; i++) data.push(Math.floor(Math.random() * 9 + 1) * 10); // 10, 20... 90

            let qText = "";
            let options = [];

            // éš¨æ©Ÿæ±ºå®šè©²ä¸»é¡Œä¸‹çš„é¡Œç›®é¡å‹
            const qType = Math.floor(Math.random() * 3);

            if(currentStage === 1) { // ç¬¬ä¸€é—œï¼šåŸºç¤å ±è®€
                let targetIdx = Math.floor(Math.random()*4);
                qText = `è«‹å•ã€Œ${scene.items[targetIdx]}ã€ä»£è¡¨çš„æ•¸å€¼æ˜¯å¤šå°‘ï¼Ÿ`;
                currentAnswer = data[targetIdx].toString();
                renderBarChart(data, scene.items);
                options = [currentAnswer, (data[targetIdx]+10).toString(), (data[targetIdx]-10).toString(), "100"];
            } 
            else if(currentStage === 2) { // ç¬¬äºŒé—œï¼šé‹ç®—èˆ‡åˆ†æ
                renderBarChart(data, scene.items);
                if(qType === 0) { // æœ€é«˜
                    qText = `å“ªä¸€å€‹é …ç›®ä»£è¡¨çš„æ•¸å€¼ã€Œæœ€é«˜ã€ï¼Ÿ`;
                    currentAnswer = scene.items[data.indexOf(Math.max(...data))];
                    options = scene.items;
                } else if(qType === 1) { // æ¯”è¼ƒ
                    let idx1 = 0, idx2 = 1;
                    qText = `è«‹å•ã€Œ${scene.items[idx1]}ã€æ¯”ã€Œ${scene.items[idx2]}ã€å¤šäº†å¤šå°‘ï¼Ÿ`;
                    currentAnswer = Math.abs(data[idx1] - data[idx2]).toString();
                    options = [currentAnswer, "10", "20", "5"];
                } else { // ç¸½å’Œ
                    let idx1 = 0, idx2 = 1;
                    qText = `ã€Œ${scene.items[idx1]}ã€å’Œã€Œ${scene.items[idx2]}ã€åˆè¨ˆæ˜¯å¤šå°‘ï¼Ÿ`;
                    currentAnswer = (data[idx1] + data[idx2]).toString();
                    options = [currentAnswer, (data[idx1]+data[idx2]+10).toString(), "50", "100"];
                }
            } 
            else { // ç¬¬ä¸‰é—œï¼šæŠ˜ç·šåœ–
                let lineLabels = ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ"];
                renderLineChart(data, lineLabels);
                if(qType === 0) {
                    qText = `å¾ 2æœˆ åˆ° 3æœˆï¼Œæ•¸å€¼çš„è®ŠåŒ–è¶¨å‹¢æ˜¯ï¼Ÿ`;
                    currentAnswer = data[2] > data[1] ? "ä¸Šå‡" : (data[2] < data[1] ? "ä¸‹é™" : "ä¸è®Š");
                    options = ["ä¸Šå‡", "ä¸‹é™", "ä¸è®Š", "ä¸ç¢ºå®š"];
                } else if (qType === 1) {
                    qText = `è«‹å•å“ªä¸€å€‹æœˆä»½çš„æ•¸å€¼æœ€ä½ï¼Ÿ`;
                    currentAnswer = lineLabels[data.indexOf(Math.min(...data))];
                    options = lineLabels;
                } else {
                    qText = `4æœˆ çš„æ•¸å€¼æ˜¯å¤šå°‘ï¼Ÿ`;
                    currentAnswer = data[3].toString();
                    options = [currentAnswer, (data[3]+10).toString(), (data[3]-10).toString(), "0"];
                }
            }

            document.getElementById('question-text').innerText = qText;
            options = [...new Set(options)].sort(() => Math.random() - 0.5);

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "option-btn";
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(opt);
                optionsDiv.appendChild(btn);
            });
        }

        // --- ç¹ªåœ–å·¥å…· ---
        function renderBarChart(data, labels) {
            const container = document.getElementById('visual-container');
            data.forEach((val, i) => {
                const bar = document.createElement('div');
                bar.className = "bar";
                bar.style.height = (val * 1.8) + "px";
                bar.innerHTML = `
                    <span style="position:absolute; top:-25px; width:100%; font-size:12px; color:#5D5FEF; font-weight:bold;">${val}</span>
                    <div class="bar-label">${labels[i]}</div>
                `;
                container.appendChild(bar);
            });
        }

        function renderLineChart(data, labels) {
            const container = document.getElementById('visual-container');
            let points = data.map((val, i) => `${i*60 + 40},${180 - val*1.8}`).join(' ');
            container.innerHTML = `
                <svg width="250" height="200" style="overflow:visible">
                    <line x1="30" y1="180" x2="230" y2="180" stroke="#ccc" />
                    <polyline fill="none" stroke="#5D5FEF" stroke-width="4" stroke-linecap="round" points="${points}" />
                    ${data.map((val, i) => `
                        <circle cx="${i*60+40}" cy="${180-val*1.8}" r="6" fill="#FFB800" />
                        <text x="${i*60+30}" y="${180-val*1.8-15}" font-size="12" fill="#5D5FEF" font-weight="bold">${val}</text>
                    `).join('')}
                    ${labels.map((l, i) => `<text x="${i*60+25}" y="200" font-size="14" font-weight="bold">${l}</text>`).join('')}
                </svg>`;
        }

        // --- åˆ¤å®šèˆ‡å›é¥‹ ---
        function checkAnswer(selected) {
            if(!isAcceptingInput) return;
            isAcceptingInput = false;

            const feedback = document.getElementById('feedback');
            const icon = document.getElementById('feedback-icon');
            const txt = document.getElementById('feedback-text');
            const ansTxt = document.getElementById('feedback-answer');

            feedback.classList.remove('hidden', 'correct-bg', 'wrong-bg');

            if(selected === currentAnswer) {
                combo++;
                score += 50 + (combo * 10);
                timeLeft += 5;
                feedback.classList.add('correct-bg');
                icon.className = "fas fa-check-circle feedback-icon";
                txt.innerText = "ç­”å°äº†ï¼ä½ çœŸå²å®³ï¼";
                ansTxt.innerText = "";
            } else {
                combo = 0;
                timeLeft -= 5;
                feedback.classList.add('wrong-bg');
                icon.className = "fas fa-times-circle feedback-icon";
                txt.innerText = "ç­”éŒ¯å›‰ï¼Œæ²’é—œä¿‚ï¼";
                ansTxt.innerText = `æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼šã€${currentAnswer}ã€‘`;
            }

            updateStats();

            setTimeout(() => {
                feedback.classList.add('hidden');
                isAcceptingInput = true;
                if(timeLeft > 0) nextQuestion();
                else endGame();
            }, 1500); // å»¶é•·å›é¥‹æ™‚é–“è®“å­¸ç”Ÿçœ‹æ¸…æ¥šæ­£ç¢ºç­”æ¡ˆ
        }

        function endGame() {
            clearInterval(timerInterval);
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = score;
            
            let stars = score > 1500 ? "â­â­â­" : (score > 800 ? "â­â­" : "â­");
            document.getElementById('star-rating').innerText = stars;

            saveScore(playerName, score);
            showLeaderboard();
        }

        function saveScore(name, score) {
            let scores = JSON.parse(localStorage.getItem('math_king_scores') || "[]");
            scores.push({name, score, date: new Date().toLocaleDateString()});
            scores.sort((a,b) => b.score - a.score);
            localStorage.setItem('math_king_scores', JSON.stringify(scores.slice(0, 5)));
        }

        function showLeaderboard() {
            const list = document.getElementById('leader-list');
            let scores = JSON.parse(localStorage.getItem('math_king_scores') || "[]");
            list.innerHTML = scores.map((s, i) => `
                <li style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee;">
                    <span>${i+1}. ${s.name}</span>
                    <span style="font-weight:bold; color:var(--secondary-blue);">${s.score} åˆ†</span>
                </li>`).join('');
        }
    </script>
</body>
</html>